@page "/"
@namespace LANdalf.UI.Pages
@using LANdalf.UI.ApiClient
@using LANdalf.UI.Services
@using System.Threading.Tasks
@inject LANdalfApiService LANdalfApiService
@inject IDialogService DialogService
@inject IDeviceValidationService ValidationService

<PageTitle>LANdalf</PageTitle>

@if (!IsLoading) {

    <MudDataGrid @ref="_grid"
                 Items="devices"
                 MultiSelection="false"
                 Filterable="true"
                 Dense="true"
                 ReadOnly="false"
                 Bordered="true"
                 EditMode="DataGridEditMode.Form"
                 EditDialogOptions="new DialogOptions { BackdropClick=false, CloseOnEscapeKey=true }"
                 CommittedItemChanges="@(async (PcDeviceDTO dto) => await CommittedItemChanges(dto))"
                 EditTrigger="DataGridEditTrigger.Manual">
        <ToolBarContent>
            <MudText Typo="Typo.h6">Devices</MudText>
            <MudSpacer />
            <MudButtonGroup Class="ma-0 pa-0" Color="Color.Success" Variant="Variant.Filled">
                <MudButton OnClick="NewDeviceAsync">
                    Add New Device
                </MudButton>
            </MudButtonGroup>
        </ToolBarContent>
        <Columns>
            <PropertyColumn Property="x => x.Name" Title="Name">
                <EditTemplate>
                    <MudTextField @bind-Value="context.Item.Name"
                                  Label="Name"
                                  Required="true"
                                  RequiredError="Name is required"
                                  MaxLength="64"
                                  Counter="64"
                                  Immediate="true"
                                  Validation="@(new Func<string?, string?>(ValidationService.ValidateName))"
                                  Variant="Variant.Outlined" />
                </EditTemplate>
            </PropertyColumn>
            <PropertyColumn Property="x => x.MacAddress" Title="MAC Address">
                <EditTemplate>
                    <MudTextField @bind-Value="context.Item.MacAddress"
                                  Label="MAC Address"
                                  Required="true"
                                  RequiredError="MAC Address is required"
                                  Immediate="true"
                                  Validation="@(new Func<string?, string?>(ValidationService.ValidateMacAddress))"
                                  Variant="Variant.Outlined"
                                  HelperText="Format: XX:XX:XX:XX:XX:XX, XX-XX-XX-XX-XX-XX, or XXXXXXXXXXXX" />
                </EditTemplate>
            </PropertyColumn>
            @*<PropertyColumn Property="x => x.IpAddress" Title="IP Address">
                <EditTemplate>
                    <MudTextField @bind-Value="context.Item.IpAddress"
                                  Label="IP Address (optional)"
                                  Immediate="true"
                                  Validation="@(new Func<string, string?>(ValidationService.ValidateIpAddress))"
                                  Variant="Variant.Outlined" />
                </EditTemplate>
            </PropertyColumn>
            <PropertyColumn Property="x => x.BroadcastAddress" Title="Broadcast Address">
                <EditTemplate>
                    <MudTextField @bind-Value="context.Item.BroadcastAddress"
                                  Label="Broadcast Address (optional)"
                                  Immediate="true"
                                  Validation="@(new Func<string, string?>(ValidationService.ValidateIpAddress))"
                                  Variant="Variant.Outlined" />
                </EditTemplate>
            </PropertyColumn>*@
            <TemplateColumn>
                <CellTemplate>
                    <MudButton ButtonType="ButtonType.Button" Variant="Variant.Filled" Color="Color.Primary"
                               OnClick="@(async () => await WakePcDevice(context.Item))">
                        Start
                    </MudButton>
                </CellTemplate>
            </TemplateColumn>
            <TemplateColumn>
                <CellTemplate>
                    <MudIconButton Size="@Size.Small" Icon="@Icons.Material.Outlined.Edit" OnClick="@context.Actions.StartEditingItemAsync" />
                    <MudIconButton Size="@Size.Small" Icon="@Icons.Material.Outlined.Delete" OnClick="@(() => DeleteDeviceAsync(context.Item))" />
                </CellTemplate>
            </TemplateColumn>
        </Columns>
        <PagerContent>
            <MudDataGridPager T="PcDeviceDTO" />
        </PagerContent>
    </MudDataGrid>
} else {
    <MudStack Class="mt-5" Justify="Justify.Center" AlignItems="AlignItems.Center">
        <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
    </MudStack>
}

@code {

    private IEnumerable<PcDeviceDTO> devices = new List<PcDeviceDTO>();
    private MudDataGrid<PcDeviceDTO> _grid = default!;
    private bool IsLoading { get; set; }


    protected override async Task OnInitializedAsync() {
        await LoadData();
    }

    private async Task LoadData() {
        try {
            IsLoading = true;
            var result = await LANdalfApiService.GetAllPcDevicesAsync(CancellationToken);
            if (result.IsError) {
                await DialogService.ShowMessageBox("Error", result.Error!.Message);
            } else {
                devices = result.Value!;
            }
        } finally {
            IsLoading = false;
        }
    }

    private async Task NewDeviceAsync() {
        var device = new PcDeviceDTO();
        await _grid.SetEditingItemAsync(device);
    }

    private async Task DeleteDeviceAsync(PcDeviceDTO item) {
        var msgResult = await DialogService.ShowMessageBox(
            title: "Delete Device",
            message: $"Do you really want to delete the device '{item.Name}'?",
            yesText: "Delete",
            noText: "Cancel"
        );
        if (msgResult is not true) {
            return;
        }

        var result = await LANdalfApiService.DeletePcDeviceAsync(item.Id, CancellationToken);
        if (result.IsSuccess) {
            await LoadData();
        } else {
            await DialogService.ShowMessageBox("Error", result.Error!.Message);
        }
    }

    private async Task CommittedItemChanges(PcDeviceDTO item) {
        if (item.Id == 0) {
            var createDTO = new PcCreateDto {
                Name = item.Name,
                MacAddress = item.MacAddress,
                IpAddress = item.IpAddress,
                BroadcastAddress = item.BroadcastAddress
            };
            var resultAdd = await LANdalfApiService.AddPcDeviceAsync(createDTO, CancellationToken);
            if (resultAdd.IsSuccess) {
                await LoadData();
            } else {
                await DialogService.ShowMessageBox("Error", resultAdd.Error!.Message);
            }
            return;
        }

        var result = await LANdalfApiService.UpdatePcDevice(item, CancellationToken);
        if (result.IsSuccess) {
            await LoadData();
        } else {
            await DialogService.ShowMessageBox("Error", result.Error!.Message);
        }
    }

    private async Task WakePcDevice(PcDeviceDTO item) {
        var result = await LANdalfApiService.WakePcDeviceAsync(item.Id, CancellationToken);
        if (result.IsError) {
            await DialogService.ShowMessageBox("Error", result.Error!.Message);
        }        
    }
}
